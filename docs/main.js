(()=>{"use strict";const t=2.3283064365386963e-10;class e{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(e){return e=e<1?1/e:e,this._seed=e,this._s0=(e>>>0)*t,e=69069*e+1>>>0,this._s1=e*t,e=69069*e+1>>>0,this._s2=e*t,this._c=1,this}getUniform(){let e=2091639*this._s0+this._c*t;return this._s0=this._s1,this._s1=this._s2,this._c=0|e,this._s2=e-this._c,this._s2}getUniformInt(t,e){let i=Math.max(t,e),s=Math.min(t,e);return Math.floor(this.getUniform()*(i-s+1))+s}getNormal(t=0,e=1){let i,s,n;do{i=2*this.getUniform()-1,s=2*this.getUniform()-1,n=i*i+s*s}while(n>1||0==n);return t+i*Math.sqrt(-2*Math.log(n)/n)*e}getPercentage(){return 1+Math.floor(100*this.getUniform())}getItem(t){return t.length?t[Math.floor(this.getUniform()*t.length)]:null}shuffle(t){let e=[],i=t.slice();for(;i.length;){let t=i.indexOf(this.getItem(i));e.push(i.splice(t,1)[0])}return e}getWeightedValue(t){let e=0;for(let i in t)e+=t[i];let i,s=this.getUniform()*e,n=0;for(i in t)if(n+=t[i],s<n)return i;return i}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this}clone(){return(new e).setState(this.getState())}}(new e).setSeed(Date.now());class i{getContainer(){return null}setOptions(t){this._options=t}}class s extends i{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(t){requestAnimationFrame(t)}getContainer(){return this._ctx.canvas}setOptions(t){super.setOptions(t);const e=`${t.fontStyle?`${t.fontStyle} `:""} ${t.fontSize}px ${t.fontFamily}`;this._ctx.font=e,this._updateSize(),this._ctx.font=e,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height)}eventToPosition(t,e){let i=this._ctx.canvas,s=i.getBoundingClientRect();return t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}}class n extends s{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(t,e){let[i,s,n,r,o]=t,a=[(i+1)*this._spacingX,s*this._spacingY+this._hexSize];if(this._options.transpose&&a.reverse(),e&&(this._ctx.fillStyle=o,this._fill(a[0],a[1])),!n)return;this._ctx.fillStyle=r;let h=[].concat(n);for(let t=0;t<h.length;t++)this._ctx.fillText(h[t],a[0],Math.ceil(a[1]))}computeSize(t,e){return this._options.transpose&&(t+=e,t-=e=t-e),[Math.floor(t/this._spacingX)-1,Math.floor((e-2*this._hexSize)/this._spacingY+1)]}computeFontSize(t,e){this._options.transpose&&(t+=e,t-=e=t-e);let i=2*t/((this._options.width+1)*Math.sqrt(3))-1,s=e/(2+1.5*(this._options.height-1)),n=Math.min(i,s),r=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let o=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=r;let a=o/100;n=Math.floor(n)+1;let h=2*n/(this._options.spacing*(1+a/Math.sqrt(3)));return Math.ceil(h)-1}_normalizedEventToPosition(t,e){let i;this._options.transpose?(t+=e,t-=e=t-e,i=this._ctx.canvas.width):i=this._ctx.canvas.height;let s=i/this._options.height;return function(t,e){return(t%e+e)%e}(e=Math.floor(e/s),2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,e]}_fill(t,e){let i=this._hexSize,s=this._options.border;const n=this._ctx;n.beginPath(),this._options.transpose?(n.moveTo(t-i+s,e),n.lineTo(t-i/2+s,e+this._spacingX-s),n.lineTo(t+i/2-s,e+this._spacingX-s),n.lineTo(t+i-s,e),n.lineTo(t+i/2-s,e-this._spacingX+s),n.lineTo(t-i/2+s,e-this._spacingX+s),n.lineTo(t-i+s,e)):(n.moveTo(t,e-i+s),n.lineTo(t+this._spacingX-s,e-i/2+s),n.lineTo(t+this._spacingX-s,e+i/2-s),n.lineTo(t,e+i-s),n.lineTo(t-this._spacingX+s,e+i/2-s),n.lineTo(t-this._spacingX+s,e-i/2+s),n.lineTo(t,e-i+s)),n.fill()}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);let i,s;this._hexSize=Math.floor(t.spacing*(t.fontSize+e/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,t.transpose?(i="height",s="width"):(i="width",s="height"),this._ctx.canvas[i]=Math.ceil((t.width+1)*this._spacingX),this._ctx.canvas[s]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)}}const r=(()=>{class t extends s{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(t){super.setOptions(t),this._canvasCache={}}draw(e,i){t.cache?this._drawWithCache(e):this._drawNoCache(e,i)}_drawWithCache(t){let e,[i,s,n,r,o]=t,a=""+n+r+o;if(a in this._canvasCache)e=this._canvasCache[a];else{let t=this._options.border;e=document.createElement("canvas");let i=e.getContext("2d");if(e.width=this._spacingX,e.height=this._spacingY,i.fillStyle=o,i.fillRect(t,t,e.width-t,e.height-t),n){i.fillStyle=r,i.font=this._ctx.font,i.textAlign="center",i.textBaseline="middle";let t=[].concat(n);for(let e=0;e<t.length;e++)i.fillText(t[e],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[a]=e}this._ctx.drawImage(e,i*this._spacingX,s*this._spacingY)}_drawNoCache(t,e){let[i,s,n,r,o]=t;if(e){let t=this._options.border;this._ctx.fillStyle=o,this._ctx.fillRect(i*this._spacingX+t,s*this._spacingY+t,this._spacingX-t,this._spacingY-t)}if(!n)return;this._ctx.fillStyle=r;let a=[].concat(n);for(let t=0;t<a.length;t++)this._ctx.fillText(a[t],(i+.5)*this._spacingX,Math.ceil((s+.5)*this._spacingY))}computeSize(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}computeFontSize(t,e){let i=Math.floor(t/this._options.width),s=Math.floor(e/this._options.height),n=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let r=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=n;let o=r/100*s/i;return o>1&&(s=Math.floor(s/o)),Math.floor(s/this._options.spacing)}_normalizedEventToPosition(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),t.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=t.width*this._spacingX,this._ctx.canvas.height=t.height*this._spacingY}}return t.cache=!1,t})();class o extends s{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(t,e){let[i,s,n,r,o]=t,a=this._options.tileWidth,h=this._options.tileHeight;if(e&&(this._options.tileColorize?this._ctx.clearRect(i*a,s*h,a,h):(this._ctx.fillStyle=o,this._ctx.fillRect(i*a,s*h,a,h))),!n)return;let l=[].concat(n),c=[].concat(r),u=[].concat(o);for(let t=0;t<l.length;t++){let e=this._options.tileMap[l[t]];if(!e)throw new Error(`Char "${l[t]}" not found in tileMap`);if(this._options.tileColorize){let n=this._colorCanvas,r=n.getContext("2d");r.globalCompositeOperation="source-over",r.clearRect(0,0,a,h);let o=c[t],l=u[t];r.drawImage(this._options.tileSet,e[0],e[1],a,h,0,0,a,h),"transparent"!=o&&(r.fillStyle=o,r.globalCompositeOperation="source-atop",r.fillRect(0,0,a,h)),"transparent"!=l&&(r.fillStyle=l,r.globalCompositeOperation="destination-over",r.fillRect(0,0,a,h)),this._ctx.drawImage(n,i*a,s*h,a,h)}else this._ctx.drawImage(this._options.tileSet,e[0],e[1],a,h,i*a,s*h,a,h)}}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._options;this._ctx.canvas.width=t.width*t.tileWidth,this._ctx.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight}}function a(t){let e,i;if(t in h)e=h[t];else{if("#"==t.charAt(0)){let i=(t.match(/[0-9a-f]/gi)||[]).map((t=>parseInt(t,16)));if(3==i.length)e=i.map((t=>17*t));else{for(let t=0;t<3;t++)i[t+1]+=16*i[t],i.splice(t,1);e=i}}else e=(i=t.match(/rgb\(([0-9, ]+)\)/i))?i[1].split(/\s*,\s*/).map((t=>parseInt(t))):[0,0,0];h[t]=e}return e.slice()}const h={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]};class l extends i{constructor(){super(),this._uniforms={};try{this._gl=this._initWebGL()}catch(t){alert(t.message)}}static isSupported(){return!!document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0})}schedule(t){requestAnimationFrame(t)}getContainer(){return this._gl.canvas}setOptions(t){super.setOptions(t),this._updateSize();let e=this._options.tileSet;e&&"complete"in e&&!e.complete?e.addEventListener("load",(()=>this._updateTexture(e))):this._updateTexture(e)}draw(t,e){const i=this._gl,s=this._options;let[n,r,o,a,h]=t,l=i.canvas.height-(r+1)*s.tileHeight;if(i.scissor(n*s.tileWidth,l,s.tileWidth,s.tileHeight),e&&(s.tileColorize?i.clearColor(0,0,0,0):i.clearColor(...g(h)),i.clear(i.COLOR_BUFFER_BIT)),!o)return;let c=[].concat(o),u=[].concat(h),p=[].concat(a);i.uniform2fv(this._uniforms.targetPosRel,[n,r]);for(let t=0;t<c.length;t++){let e=this._options.tileMap[c[t]];if(!e)throw new Error(`Char "${c[t]}" not found in tileMap`);i.uniform1f(this._uniforms.colorize,s.tileColorize?1:0),i.uniform2fv(this._uniforms.tilesetPosAbs,e),s.tileColorize&&(i.uniform4fv(this._uniforms.tint,g(p[t])),i.uniform4fv(this._uniforms.bg,g(u[t]))),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}clear(){const t=this._gl;t.clearColor(...g(this._options.bg)),t.scissor(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT)}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}eventToPosition(t,e){let i=this._gl.canvas,s=i.getBoundingClientRect();return t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}_initWebGL(){let t=document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0});window.gl=t;let e=function(t,e,i){const s=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(s,e),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(s)||"");const n=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(n,i),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(n)||"");const r=t.createProgram();if(t.attachShader(r,s),t.attachShader(r,n),t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(r)||"");return r}(t,u,p);return t.useProgram(e),function(t){const e=new Float32Array([0,0,1,0,0,1,1,1]),i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0)}(t),c.forEach((i=>this._uniforms[i]=t.getUniformLocation(e,i))),this._program=e,t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.enable(t.SCISSOR_TEST),t}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._gl,e=this._options,i=[e.width*e.tileWidth,e.height*e.tileHeight];t.canvas.width=i[0],t.canvas.height=i[1],t.viewport(0,0,i[0],i[1]),t.uniform2fv(this._uniforms.tileSize,[e.tileWidth,e.tileHeight]),t.uniform2fv(this._uniforms.targetSize,i)}_updateTexture(t){!function(t,e){let i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e)}(this._gl,t)}}const c=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint"],u="\n#version 300 es\n\nin vec2 tilePosRel;\nout vec2 tilesetPosPx;\n\nuniform vec2 tilesetPosAbs;\nuniform vec2 tileSize;\nuniform vec2 targetSize;\nuniform vec2 targetPosRel;\n\nvoid main() {\n\tvec2 targetPosPx = (targetPosRel + tilePosRel) * tileSize;\n\tvec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;\n\ttargetPosNdc.y *= -1.0;\n\n\tgl_Position = vec4(targetPosNdc, 0.0, 1.0);\n\ttilesetPosPx = tilesetPosAbs + tilePosRel * tileSize;\n}".trim(),p="\n#version 300 es\nprecision highp float;\n\nin vec2 tilesetPosPx;\nout vec4 fragColor;\nuniform sampler2D image;\nuniform bool colorize;\nuniform vec4 bg;\nuniform vec4 tint;\n\nvoid main() {\n\tfragColor = vec4(0, 0, 0, 1);\n\n\tvec4 texel = texelFetch(image, ivec2(tilesetPosPx), 0);\n\n\tif (colorize) {\n\t\ttexel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;\n\t\tfragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;\n\t\tfragColor.a = texel.a + (1.0-texel.a)*bg.a;\n\t} else {\n\t\tfragColor = texel;\n\t}\n}".trim();let d={};function g(t){if(!(t in d)){let e;if("transparent"==t)e=[0,0,0,0];else if(t.indexOf("rgba")>-1){e=(t.match(/[\d.]+/g)||[]).map(Number);for(let t=0;t<3;t++)e[t]=e[t]/255}else e=a(t).map((t=>t/255)),e.push(1);d[t]=e}return d[t]}function m(t){const e=6/256;let i=a(t);return 36*Math.floor(i[0]*e)+6*Math.floor(i[1]*e)+1*Math.floor(i[2]*e)+16}class f extends i{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(t){setTimeout(t,1e3/60)}setOptions(t){super.setOptions(t);let e=[t.width,t.height],i=this.computeSize();this._offset=i.map(((t,i)=>Math.floor((t-e[i])/2)))}clear(){process.stdout.write(`[0;48;5;${m(this._options.bg)}m[2J`)}draw(t,e){let[i,s,n,r,o]=t,a=this._offset[0]+i,h=this._offset[1]+s,l=this.computeSize();if(a<0||a>=l[0])return;if(h<0||h>=l[1])return;if(a===this._cursor[0]&&h===this._cursor[1]||(process.stdout.write(function(t,e){return`[${e+1};${t+1}H`}(a,h)),this._cursor[0]=a,this._cursor[1]=h),e&&(n||(n=" ")),!n)return;let c=function(t,e){return`[0;38;5;${m(t)};48;5;${m(e)}m`}(r,o);if(c!==this._lastColor&&(process.stdout.write(c),this._lastColor=c),"\t"!=n){let t=[].concat(n);process.stdout.write(t[0])}this._cursor[0]++,this._cursor[0]>=l[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(t,e){return[t,e]}computeSize(){return[process.stdout.columns,process.stdout.rows]}}const _=/%([bc]){([^}]*)}/g;function y(t,e,i,s){let n={type:0,value:t[e].value.substring(i+(s?1:0))};return t.splice(e+1,0,{type:1},n),t[e].value.substring(0,i)}const w={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},v={hex:n,rect:r,tile:o,"tile-gl":l,term:f},x={width:80,height:25,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1},b=(()=>{class t{constructor(t={}){this._data={},this._dirty=!1,this._options={},t=Object.assign({},x,t),this.setOptions(t),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(t,e,i){let s=[this._options.bg,this._options.fg];this.draw(t,e,null,null,s[i%s.length])}clear(){this._data={},this._dirty=!0}setOptions(t){if(Object.assign(this._options,t),t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){if(t.layout){let e=v[t.layout];this._backend=new e}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(t,e){return this._backend.computeSize(t,e)}computeFontSize(t,e){return this._backend.computeFontSize(t,e)}computeTileSize(t,e){return[Math.floor(t/this._options.width),Math.floor(e/this._options.height)]}eventToPosition(t){let e,i;return"touches"in t?(e=t.touches[0].clientX,i=t.touches[0].clientY):(e=t.clientX,i=t.clientY),this._backend.eventToPosition(e,i)}draw(t,e,i,s,n){s||(s=this._options.fg),n||(n=this._options.bg);let r=`${t},${e}`;this._data[r]=[t,e,i,s,n],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[r]=!0)}drawText(t,e,i,s){let n=null,r=null,o=t,a=e,h=1;s||(s=this._options.width-t);let l=function(t,e){let i=[],s=0;t.replace(_,(function(e,n,r,o){let a=t.substring(s,o);return a.length&&i.push({type:0,value:a}),i.push({type:"c"==n?2:3,value:r.trim()}),s=o+e.length,""}));let n=t.substring(s);return n.length&&i.push({type:0,value:n}),function(t,e){e||(e=1/0);let i=0,s=0,n=-1;for(;i<t.length;){let r=t[i];if(1==r.type&&(s=0,n=-1),0!=r.type){i++;continue}for(;0==s&&" "==r.value.charAt(0);)r.value=r.value.substring(1);let o=r.value.indexOf("\n");if(-1!=o){r.value=y(t,i,o,!0);let e=r.value.split("");for(;e.length&&" "==e[e.length-1];)e.pop();r.value=e.join("")}if(r.value.length){if(s+r.value.length>e){let o=-1;for(;;){let t=r.value.indexOf(" ",o+1);if(-1==t)break;if(s+t>e)break;o=t}if(-1!=o)r.value=y(t,i,o,!0);else if(-1!=n){let e=t[n],s=e.value.lastIndexOf(" ");e.value=y(t,n,s,!0),i=n}else r.value=y(t,i,e-s,!1)}else s+=r.value.length,-1!=r.value.indexOf(" ")&&(n=i);i++}else t.splice(i,1)}t.push({type:1});let r=null;for(let e=0;e<t.length;e++){let i=t[e];switch(i.type){case 0:r=i;break;case 1:if(r){let t=r.value.split("");for(;t.length&&" "==t[t.length-1];)t.pop();r.value=t.join("")}r=null}}return t.pop(),t}(i,e)}(i,s);for(;l.length;){let e=l.shift();switch(e.type){case 0:let i=!1,s=!1,l=!1,c=!1;for(let t=0;t<e.value.length;t++){let h=e.value.charCodeAt(t),u=e.value.charAt(t);if("term"===this._options.layout){let t=h>>8;if(17===t||t>=46&&t<=159||t>=172&&t<=215||h>=43360&&h<=43391){this.draw(o+0,a,u,n,r),this.draw(o+1,a,"\t",n,r),o+=2;continue}}l=h>65280&&h<65377||h>65500&&h<65512||h>65518,i=32==u.charCodeAt(0)||12288==u.charCodeAt(0),!c||l||i||o++,l&&!s&&o++,this.draw(o++,a,u,n,r),s=i,c=l}break;case 2:n=e.value||null;break;case 3:r=e.value||null;break;case 1:o=t,a++,h++}}return h}_tick(){if(this._backend.schedule(this._tick),this._dirty){if(!0===this._dirty){this._backend.clear();for(let t in this._data)this._draw(t,!1)}else for(let t in this._dirty)this._draw(t,!0);this._dirty=!1}}_draw(t,e){let i=this._data[t];i[4]!=this._options.bg&&(e=!0),this._backend.draw(i,e)}}return t.Rect=r,t.Hex=n,t.Tile=o,t.TileGL=l,t.Term=f,t})();class S{constructor(){this.heap=[],this.timestamp=0}lessThan(t,e){return t.key==e.key?t.timestamp<e.timestamp:t.key<e.key}shift(t){this.heap=this.heap.map((({key:e,value:i,timestamp:s})=>({key:e+t,value:i,timestamp:s})))}len(){return this.heap.length}push(t,e){this.timestamp+=1;const i=this.len();this.heap.push({value:t,timestamp:this.timestamp,key:e}),this.updateUp(i)}pop(){if(0==this.len())throw new Error("no element to pop");const t=this.heap[0];return this.len()>1?(this.heap[0]=this.heap.pop(),this.updateDown(0)):this.heap.pop(),t}find(t){for(let e=0;e<this.len();e++)if(t==this.heap[e].value)return this.heap[e];return null}remove(t){let e=null;for(let i=0;i<this.len();i++)t==this.heap[i].value&&(e=i);if(null===e)return!1;if(this.len()>1){let i=this.heap.pop();return i.value!=t&&(this.heap[e]=i,this.updateDown(e)),!0}return this.heap.pop(),!0}parentNode(t){return Math.floor((t-1)/2)}leftChildNode(t){return 2*t+1}rightChildNode(t){return 2*t+2}existNode(t){return t>=0&&t<this.heap.length}swap(t,e){const i=this.heap[t];this.heap[t]=this.heap[e],this.heap[e]=i}minNode(t){const e=t.filter(this.existNode.bind(this));let i=e[0];for(const t of e)this.lessThan(this.heap[t],this.heap[i])&&(i=t);return i}updateUp(t){if(0==t)return;const e=this.parentNode(t);this.existNode(e)&&this.lessThan(this.heap[t],this.heap[e])&&(this.swap(t,e),this.updateUp(e))}updateDown(t){const e=this.leftChildNode(t),i=this.rightChildNode(t);if(!this.existNode(e))return;const s=this.minNode([t,e,i]);s!=t&&(this.swap(t,s),this.updateDown(s))}debugPrint(){console.log(this.heap)}}class M{constructor(){this._time=0,this._events=new S}getTime(){return this._time}clear(){return this._events=new S,this}add(t,e){this._events.push(t,e)}get(){if(!this._events.len())return null;let{key:t,value:e}=this._events.pop();return t>0&&(this._time+=t,this._events.shift(-t)),e}getEventTime(t){const e=this._events.find(t);if(e){const{key:t}=e;return t}}remove(t){return this._events.remove(t)}}class k{constructor(){this._queue=new M,this._repeat=[],this._current=null}getTime(){return this._queue.getTime()}add(t,e){return e&&this._repeat.push(t),this}getTimeOf(t){return this._queue.getEventTime(t)}clear(){return this._queue.clear(),this._repeat=[],this._current=null,this}remove(t){let e=this._queue.remove(t),i=this._repeat.indexOf(t);return-1!=i&&this._repeat.splice(i,1),this._current==t&&(this._current=null),e}next(){return this._current=this._queue.get(),this._current}}const T=class extends k{add(t,e){return this._queue.add(t,0),super.add(t,e)}next(){return null!==this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),super.next()}};class E{constructor(t,e={}){this._lightPasses=t,this._options=Object.assign({topology:8},e)}_getCircle(t,e,i){let s,n,r,o=[];switch(this._options.topology){case 4:n=1,r=[0,1],s=[w[8][7],w[8][1],w[8][3],w[8][5]];break;case 6:s=w[6],n=1,r=[-1,1];break;case 8:s=w[4],n=2,r=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}let a=t+r[0]*i,h=e+r[1]*i;for(let t=0;t<s.length;t++)for(let e=0;e<i*n;e++)o.push([a,h]),a+=s[t][0],h+=s[t][1];return o}}const C=class extends E{compute(t,e,i,s){if(s(t,e,0,1),!this._lightPasses(t,e))return;let n,r,o,a,h,l,c=[];for(let u=1;u<=i;u++){let i=this._getCircle(t,e,u),p=i.length;for(let t=0;t<p;t++)if(n=i[t][0],r=i[t][1],a=[t?2*t-1:2*p-1,2*p],h=[2*t+1,2*p],o=!this._lightPasses(n,r),l=this._checkVisibility(a,h,o,c),l&&s(n,r,u,l),2==c.length&&0==c[0][0]&&c[1][0]==c[1][1])return}}_checkVisibility(t,e,i,s){if(t[0]>e[0])return(this._checkVisibility(t,[t[1],t[1]],i,s)+this._checkVisibility([0,1],e,i,s))/2;let n=0,r=!1;for(;n<s.length;){let e=s[n],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0!=i||n%2||(r=!0);break}n++}let o=s.length,a=!1;for(;o--;){let t=s[o],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0==i&&o%2&&(a=!0);break}}let h,l=!0;if((n==o&&(r||a)||r&&a&&n+1==o&&o%2||n>o&&n%2)&&(l=!1),!l)return 0;let c=o-n+1;if(c%2)if(n%2){let t=s[n];h=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(n,c,e)}else{let e=s[o];h=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(n,c,t)}else{if(!(n%2))return i&&s.splice(n,c,t,e),1;{let t=s[n],e=s[o];h=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(n,c)}}return h/((e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]))}};Math.sqrt(3),Math.sqrt(3);class A{constructor(t,e,i,s={}){this._toX=t,this._toY=e,this._passableCallback=i,this._options=Object.assign({topology:8},s),this._dirs=w[this._options.topology],8==this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])}_getNeighbors(t,e){let i=[];for(let s=0;s<this._dirs.length;s++){let n=this._dirs[s],r=t+n[0],o=e+n[1];this._passableCallback(r,o)&&i.push([r,o])}return i}}const P=class extends A{constructor(t,e,i,s){super(t,e,i,s),this._computed={},this._todo=[],this._add(t,e,null)}compute(t,e,i){let s=t+","+e;if(s in this._computed||this._compute(t,e),!(s in this._computed))return;let n=this._computed[s];for(;n;)i(n.x,n.y),n=n.prev}_compute(t,e){for(;this._todo.length;){let i=this._todo.shift();if(i.x==t&&i.y==e)return;let s=this._getNeighbors(i.x,i.y);for(let t=0;t<s.length;t++){let e=s[t],n=e[0],r=e[1];n+","+r in this._computed||this._add(n,r,i)}}}_add(t,e,i){let s={x:t,y:e,prev:i};this._computed[t+","+e]=s,this._todo.push(s)}},I="black",L="#404040",q=I;class R{constructor(t,e,i){this.char=t,this.fgColor=e,this.bgColor=i}}class z{constructor(t,e,i,s){this.walkable=t,this.transparent=e,this.darkTile=i,this.lightTile=s}}const N=new R("░","#909090","black");new z(!0,!0,new R(".",I,"#909090"),new R(".",I,"#C8C8C8")),new z(!1,!1,new R(" ",L,L),new R(" ",q,q));class ${constructor(){this._resolvers=[],this._promises=[]}_add(){this._promises.push(new Promise((t=>{this._resolvers.push(t)})))}enqueue(t){this._resolvers.length||this._add(),this._resolvers.shift()(t)}dequeue(){return this._promises.length||this._add(),this._promises.shift()}isEmpty(){return!this._promises.length}isBlocked(){return!!this._resolvers.length}get length(){return this._promises.length-this._resolvers.length}}class O{}function X(t=0,e){return Math.floor(Math.random()*(e-t+1)+t)}class D{constructor(t,e,i,s,n){this.entities=new Set,this.name=t,this.label=e,this.width=i,this.height=s,this.tiles=n,this.visible=[],this.explored=[];for(let t=0;t<i;t++){this.visible.push([]),this.explored.push([]);for(let e=0;e<s;e++)this.visible[t].push(!1),this.explored[t].push(!0)}}get xOffset(){return Math.floor((60-this.width)/2)}get yOffset(){return Math.floor((36-this.height)/2)}resetVisible(){for(let t=0;t<this.width;t++)for(let e=0;e<this.height;e++)this.visible[t][e]=!1}place(t,e,i){t.x=e,t.y=i,this.entities.add(t)}inBounds(t,e){return 0<=t&&t<this.width&&0<=e&&e<this.height}getActorAt(t,e){for(let i of this.entities)if(i.x==t&&i.y==e&&i instanceof xt&&i.stats)return i;return null}getSiteAt(t,e){for(let i of this.entities)if(i.x==t&&i.y==e&&i instanceof St)return i;return null}getBlockingEntityAt(t,e){for(let i of this.entities)if(i.x==t&&i.y==e&&i.isBlocking)return i;return null}getEntitiesAt(t,e){let i=[];for(let s of this.entities)s.x==t&&s.y==e&&i.push(s);return i}placeRandom(t){let e,i;for(;e=X(0,this.width-1),i=X(0,this.height-1),!this.tiles[e][i].walkable||this.getBlockingEntityAt(e,i););this.place(t,e,i)}}var H,B,U,F=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function o(t){try{h(s.next(t))}catch(t){r(t)}}function a(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((s=s.apply(t,e||[])).next())}))},Y=new O;function W(t,e){return F(this,void 0,void 0,(function*(){let i;switch(console.log(`loadData(${t})`),e){case B.TerrainDef:i=V;break;case B.Map:i=K;break;default:i=null}return yield fetch(`./data/${t}`).then((t=>t.text().then((t=>i(t)))))}))}function V(t){let e=new O,i=t.split("\n");for(let t of i)if(!t.startsWith("#")&&""!=t.trim()){let i=t.split("|");if(9!=i.length){console.log("!! Malformed terrain definition line"),console.log(`[${t}]`);continue}let s=i[0],n="true"==i[1].toLowerCase(),r="true"==i[2].toLowerCase(),o=i[3],a=i[4],h=i[5],l=i[6],c=i[7],u=i[8],p=new z(n,r,new R(o,a,h),new R(l,c,u));e[s]=p}return e}function K(t){let e,i,s,n,r,o=t.split("\n"),a=new O;for(let t of o)if(!t.startsWith("#")&&""!=t.trim())if("%%map"==t.trim().toLowerCase()){if(s){let t=G(s,n,r);t&&(Y[t.name]=t)}s=new O,n=[],r=[]}else if(t.startsWith("%")){let e=t.substring(1).trim().toLowerCase();"metadata"===e?i=U.Metadata:"terrain_codes"===e?i=U.TerrainCodes:"tile_list"===e?i=U.TileList:"item_list"===e?i=U.ItemList:"site_list"===e?i=U.SiteList:console.log(`!! Invalid section name: ${e}`)}else switch(i){case null:console.log("!! Invalid data before section start:"),console.log(t);break;case U.Metadata:if(t.includes(":")){let e=t.split(":");s[e[0]]=e[1]}else console.log("!! Invalid metadata:"),console.log(t);break;case U.TerrainCodes:if(t.includes(":")){let e=t.split(":"),i=e[0],s=e[1];s in H?a[i]=H[s]:(console.log(`!! Unknown terrain: [${s}]`),console.log(t))}else console.log("!! Invalid terrain code:"),console.log(t);break;case U.TileList:e=t.split("|");let i=[],o=!0;for(let t of e){if(!(t in a)){console.log(`!! Unknown terrain code: [${t}]`),o=!1;break}i.push(a[t])}o&&n.push(i);break;case U.ItemList:break;case U.SiteList:if(e=t.split("|"),7!=e.length)console.log(`!! Malformed site record: [${t}]`);else{let t=e[0],i=+e[1],s=+e[2],n=e[3],o=e[4],a=e[5],h=e[6];""==n&&(n=null),""==o&&(o=null),""==a&&(a=null);let l=new St(t,n,o,a,h);l.x=i,l.y=s,r.push(l)}}let h=G(s,n,r);h&&(Y[h.name]=h)}function G(t,e,i){let s=["name","width","height"];for(let e of s)if(!(e in t))return console.log(`!! Missing mandatory metadata [${e}]`),null;let n=t.name,r=t.label;r||(r=n);let o=+t.width,a=+t.height;if(e.length!=a)return console.log(`!! Inconsistent map dimensions; found h: ${e.length}, expected: ${a}`),null;for(let t of e)if(t.length!=o)return console.log(`!! Inconsistent map dimensions; found w: ${t.length}, expected: ${o}`),null;let h=new D(n,r,o,a,function(t){let e=[];for(let i=0;i<t[0].length;i++){e.push([]);for(let s=0;s<t.length;s++)e[i].push(t[s][i])}return e}(e));for(let t of i)t.parent=h,h.entities.add(t);return"startingX"in t&&"startingY"in t&&(h.startingPos=[+t.startingX,+t.startingY]),h}!function(t){t[t.TerrainDef=0]="TerrainDef",t[t.Map=1]="Map"}(B||(B={})),function(t){t[t.Metadata=0]="Metadata",t[t.TerrainCodes=1]="TerrainCodes",t[t.TileList=2]="TileList",t[t.ItemList=3]="ItemList",t[t.SiteList=4]="SiteList"}(U||(U={}));class j{constructor(t,e){this.engine=t,this.actor=e}}class Q extends j{perform(){return this.engine.map.visible[this.actor.x][this.actor.x]&&this.engine.messageLog.addMessage(this.actor.name+" is waiting... "),{success:!0}}}class J extends j{perform(){let t=this.actor.x,e=this.actor.y,i=this.actor.inventory;for(let s of this.engine.map.entities){if(!(s instanceof bt))continue;let n=s;if(t==n.x&&e==n.y)return i.items.size>=i.capacity?{success:!1,reason:`${this.actor.name} inventory is full`}:(this.engine.map.entities.delete(n),n.parent=this.actor.inventory,i.items.add(n),this.engine.messageLog.addMessage(`${this.actor.name} picks up the ${n.name}`),{success:!0})}return{success:!1,reason:"There is nothing here to pick up"}}}class Z extends j{constructor(t,e,i,s){super(t,e),this.dx=i,this.dy=s}get destXY(){return[this.actor.x+this.dx,this.actor.y+this.dy]}get targetActor(){return this.engine.map.getActorAt(this.destXY[0],this.destXY[1])}get targetSite(){return this.engine.map.getSiteAt(this.destXY[0],this.destXY[1])}}class tt extends Z{perform(){return this.targetActor?new et(this.engine,this.actor,this.dx,this.dy).perform():this.targetSite?new st(this.engine,this.actor,this.dx,this.dy).perform():new it(this.engine,this.actor,this.dx,this.dy).perform()}}class et extends Z{perform(){let t=this.targetActor;if(!t)return{success:!1,reason:"Nothing to attack"};let e,i=this.actor.stats.att-t.stats.def,s=`${this.actor.name} attacks ${t.name}`;return e=this.actor===this.engine.player?"player-attack":"enemy-attack",i>0?(this.engine.messageLog.addMessage(`⚔ ${s} for ${i} hit points`,e),t.stats.hp-=i):this.engine.messageLog.addMessage(`⚔ ${s} but does no damage`,e),{success:!0}}}class it extends Z{perform(){let[t,e]=this.destXY;return this.engine.map.inBounds(t,e)?this.engine.map.tiles[t][e].walkable?this.engine.map.getBlockingEntityAt(t,e)?{success:!1,reason:"That way is blocked"}:(this.actor.move(this.dx,this.dy),{success:!0}):{success:!1,reason:"That way is blocked"}:new nt(this.engine,this.actor,this.dx,this.dy).perform()}}class st extends Z{perform(){let t=this.targetSite;return t?(this.engine.messageLog.addMessage(`Entering ${t.name}`),this.actor.move(this.dx,this.dy),t.mapName in Y?(this.engine.world.pushMap(Y[t.mapName]),{success:!0}):{success:!1,reason:`Unknown map: [${t.mapName}]`}):{success:!1,reason:"No site to enter"}}}class nt extends Z{perform(){return this.engine.world.mapStack.length>1?(this.engine.world.popMap(),this.engine.messageLog.addMessage(`Returning to ${this.engine.world.currMap.name}`),{success:!0}):{success:!1,reason:"That way is blocked"}}}class rt extends j{constructor(t,e,i,s){super(t,e),this.item=i,this.targetXY=s||[e.x,e.y]}get targetActor(){return this.engine.map.getActorAt(this.targetXY[0],this.targetXY[1])}}class ot extends rt{perform(){return this.actor.inventory.items.has(this.item)?(this.actor.inventory.drop(this.item),this.engine.messageLog.addMessage(`${this.actor.name} drops the ${this.item.name}`),{success:!0}):{success:!1,reason:`${this.actor.name} doesn't have that item`}}}class at extends rt{perform(){if(this.item.consumable)return this.item.consumable.use(this)}}class ht extends rt{perform(){return this.item.equippable?(this.actor.equipment.toggle(this.item),{success:!0}):{success:!1,reason:"This item is not equippable"}}}class lt extends j{constructor(t,e,i,s){super(t,e),this.item1=i,this.item2=s}perform(){return this.item1.combinable&&this.item2.combinable?this.item1.combinable.combine(this.item2.combinable):{success:!1,reason:"Only ingredients can be combined"}}}var ct=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function o(t){try{h(s.next(t))}catch(t){r(t)}}function a(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((s=s.apply(t,e||[])).next())}))};class ut{constructor(t,e){this.engine=t,this.parent=e}getPathTo(t,e){let i=this.engine.map,s=[];for(let t=0;t<i.width;t++){s.push([]);for(let e=0;e<i.height;e++)s[t].push(i.tiles[t][e].walkable)}for(let n of i.entities)!n.isBlocking||n===this.parent||n.x==t&&n.y==e||(s[n.x][n.y]=!1);let n=[];return new P(t,e,(function(t,e){return s[t][e]}),null).compute(this.parent.x,this.parent.y,(function(t,e){n.push([t,e])})),n.shift(),n}}class pt extends ut{constructor(){super(...arguments),this.path=[]}chooseAction(){return ct(this,void 0,void 0,(function*(){console.log("EnemyAI.chooseAction");let t=this.engine.player,e=t.x-this.parent.x,i=t.y-this.parent.y,s=Math.max(Math.abs(e),Math.abs(i));if(this.engine.map.visible[this.parent.x][this.parent.y]){if(s<=1)return new et(this.engine,this.parent,e,i);this.path=this.getPathTo(t.x,t.y)}if(this.path.length){let[t,e]=this.path.shift();return console.log("EnemyAI chose MovementAction"),new it(this.engine,this.parent,t-this.parent.x,e-this.parent.y)}return new Q(this.engine,this.parent)}))}}class dt extends ut{chooseAction(){return ct(this,void 0,void 0,(function*(){return this.engine.playerActionQueue.dequeue()}))}}var gt,mt,ft,_t,yt,wt;!function(t){t[t.Site=0]="Site",t[t.Corpse=1]="Corpse",t[t.Item=2]="Item",t[t.Actor=3]="Actor"}(gt||(gt={}));class vt{constructor(t,e="?",i="darkgrey",s=!1,n=gt.Item){this.name=t,this.char=e,this.color=i,this.isBlocking=s,this.renderOrder=n,this.x=0,this.y=0}move(t,e){this.x+=t,this.y+=e}}class xt extends vt{constructor(t,e,i="?",s="black"){super(e,i,s,!0,gt.Actor),this.engine=t}act(){return t=this,e=void 0,s=function*(){if(this.ai)for(;;){let t=yield this.ai.chooseAction();console.log(`Performing ${t.constructor.name}`);let e=t.perform();if(e.success||(this.engine.messageLog.addMessage(e.reason,"warning"),this.engine.gameView.renderMessages(this.engine.messageLog)),e.success||!(this.ai instanceof dt))break}},new((i=void 0)||(i=Promise))((function(n,r){function o(t){try{h(s.next(t))}catch(t){r(t)}}function a(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((s=s.apply(t,e||[])).next())}));var t,e,i,s}}class bt extends vt{constructor(t,e="?",i="black"){super(t,e,i,!1,gt.Item)}use(){}}class St extends vt{constructor(t,e="*",i="black",s="darkgrey",n){super(t,e,i,!1,gt.Site),this.darkColor=s,this.mapName=n}}class Mt{constructor(t,e,i,s,n){this.engine=t,this.parent=e,this.maxHp=i,this._hp=i,this.baseDef=s,this.baseAtt=n}get hp(){return this._hp}set hp(t){this._hp=Math.max(0,Math.min(t,this.maxHp)),0==this._hp&&this.parent.ai&&this.die()}get def(){return this.baseDef+this.bonusDef}get att(){return this.baseAtt+this.bonusAtt}get bonusAtt(){return this.parent.equipment?this.parent.equipment.bonusAtt:0}get bonusDef(){return this.parent.equipment?this.parent.equipment.bonusDef:0}heal(t){if(this.hp==this.maxHp)return 0;let e=this.hp+t;e>this.maxHp&&(e=this.maxHp);let i=e-this.hp;return this.hp=e,i}takeDamage(t){this.hp-=t}die(){let t,e;this.engine.player==this.parent?(t="✟ you died",e="player-death"):(t=`✟ ${this.parent.name} is dead`,e="enemy-death"),this.parent.name=`remains of ${this.parent.name}`,this.parent.char="%",this.parent.color="#FF3030",this.parent.isBlocking=!1,this.parent.renderOrder=gt.Corpse,this.parent.stats=null,this.parent.ai=null,this.engine.messageLog.addMessage(t,e)}}class kt{constructor(t,e,i){this.items=new Set,this.engine=t,this.parent=e,this.capacity=i}drop(t){this.items.delete(t),this.engine.map.place(t,this.parent.x,this.parent.y)}}(ft=mt||(mt={}))[ft.Weapon=0]="Weapon",ft[ft.Armor=1]="Armor";class Tt{constructor(t,e,i,s){this.items=new O,this.engine=t,this.parent=e,i&&(this.items[mt.Weapon]=i),s&&(this.items[mt.Armor]=s)}get bonusDef(){let t=0;for(let e in this.items){let i=this.items[e];i.equippable&&(t+=i.equippable.bonusDef)}return t}get bonusAtt(){let t=0;for(let e in this.items){let i=this.items[e];i.equippable&&(t+=i.equippable.bonusAtt)}return t}isEquipped(t){for(let e in this.items)if(this.items[e]===t)return!0;return!1}unequipMessage(t){this.parent.engine.messageLog.addMessage(`${this.parent} removes the ${t}`)}equipMessage(t){this.parent.engine.messageLog.addMessage(`${this.parent} equips the ${t}`)}equip(t,e,i){this.items[e]&&this.unequip(e,i),this.items[e]=t,i&&this.equipMessage(t.name)}unequip(t,e){let i=this.items[t];i&&e&&this.unequipMessage(i.name),delete this.items[t]}toggle(t,e=!0){t.equippable&&(this.items[t.equippable.equipmentType]===t?this.unequip(t.equippable.equipmentType,e):this.equip(t,t.equippable.equipmentType,e))}}new O,new O,function(t){t[t.Player=0]="Player",t[t.Orc=1]="Orc",t[t.Troll=2]="Troll"}(_t||(_t={})),(wt=yt||(yt={}))[wt.PotionHealth=0]="PotionHealth",wt[wt.PotionPoison=1]="PotionPoison",wt[wt.HerbHenbane=2]="HerbHenbane",wt[wt.HerbNightshade=3]="HerbNightshade",wt[wt.Dagger=4]="Dagger",wt[wt.LeatherArmor=5]="LeatherArmor";class Et{constructor(t){this.mapStack=[],this.engine=t}get currMap(){return this.mapStack.length?this.mapStack[this.mapStack.length-1].map:null}pushMap(t){this.mapStack.length&&(this.mapStack[this.mapStack.length-1].pos=[this.engine.player.x,this.engine.player.y]),this.mapStack.push({map:t,pos:null}),this.engine.map=t,t.startingPos?t.place(this.engine.player,t.startingPos[0],t.startingPos[1]):t.placeRandom(this.engine.player)}popMap(){if(this.mapStack.pop(),!this.currMap)throw{message:"Inconsistency in GameWorld",expected:"this.currMap is valid",actual:"this.currMap is null"};let t=this.mapStack[this.mapStack.length-1].pos;this.currMap.place(this.engine.player,t[0],t[1]),this.engine.map=this.currMap}}class Ct{constructor(t,e){this.plainText=t,this.cssClass=e,this.count=1}get fullText(){return this.count>1?`${this.plainText} (x${this.count})`:this.plainText}}class At{constructor(){this.messages=[]}addMessage(t,e,i=!0){i&&this.messages.length&&t==this.messages[this.messages.length-1].plainText?this.messages[this.messages.length-1].count+=1:this.messages.push(new Ct(t,e))}}class Pt{constructor(t){this.engine=t,this.eventListener=this.handleEvent.bind(this)}}class It extends Pt{handleEvent(t){let e=this.engine,i=null,s=t.code;if(this.compositeCommand)if(qt.has(s)){let e=1;t.getModifierState("Shift")&&(e*=5),t.getModifierState("Control")&&(e*=10),t.getModifierState("Alt")&&(e*=20);let i=qt.get(s),[n,r]=this.tileSelection,[o,a]=i;n+=o*e,r+=a*e,n=Math.max(0,Math.min(n,this.engine.map.width-1)),r=Math.max(0,Math.min(r,this.engine.map.height-1)),this.tileSelection=[n,r],this.engine.gameView.renderMap(this.engine.map,this.tileSelection)}else s in zt&&(this.engine.map.visible[this.tileSelection[0]][this.tileSelection[1]]&&this.engine.gameView.renderMapInfo(this.engine.map.getEntitiesAt(this.tileSelection[0],this.tileSelection[1])),this.compositeCommand=null,this.tileSelection=null,this.engine.gameView.renderMap(this.engine.map));else if(qt.has(s)){let t=qt.get(s);i=new tt(e,e.player,t[0],t[1])}else if(s in Rt)i=new Q(e,e.player);else if("KeyG"==s)i=new J(e,e.player);else if("KeyL"==s)this.compositeCommand=s,this.tileSelection=[this.engine.player.x,this.engine.player.y],this.engine.gameView.renderMap(this.engine.map,this.tileSelection);else if("KeyI"==s){let t=e.inventoryView.render(e.player.inventory,e.player.equipment),i=new Lt(e,t);e.setInputHandler(i),document.getElementById("dialogContainer").style.display="block",document.getElementById("inventoryDialog").style.display="block"}i&&e.playerActionQueue.enqueue(i)}}class Lt extends Pt{constructor(t,e){super(t),this.itemMap=e}get selectedItem(){return this.selectedItemKey?this.itemMap[this.selectedItemKey]:null}handleEvent(t){let e,i=this.engine,s=t.code;if("Escape"==s)this.selectedItemKey=null,this.compositeCommand=null,this.backToGame();else if(this.selectedItemKey)if(this.compositeCommand){if(t.key in this.itemMap){let s=this.itemMap[t.key];"KeyC"==this.compositeCommand&&(e=new lt(i,i.player,this.selectedItem,s))}}else"KeyD"==s?e=new ot(i,i.player,this.selectedItem):"KeyU"==s?e=new at(i,i.player,this.selectedItem):"KeyE"==s||"KeyT"==s?e=new ht(i,i.player,this.selectedItem):"KeyC"==s&&(this.compositeCommand=s,this.setSelectedRow(null));else t.key in this.itemMap&&(this.selectedItemKey=t.key,this.setSelectedRow());e&&(this.selectedItemKey=null,this.compositeCommand=null,this.setSelectedRow(),i.playerActionQueue.enqueue(e),this.backToGame())}setSelectedRow(t=this.selectedItemKey){console.log("setSelectedRow");let e=document.querySelectorAll(".inventory-row");for(let i of e)console.log(i.querySelector(".inventory-item-letter").textContent),console.log(this.selectedItemKey),this.selectedItem&&i.querySelector(".inventory-item-letter").textContent=="("+t+")"?i.classList.add("selected"):(i.classList.remove("selected"),i.querySelector(".inventory-item-command").textContent="")}backToGame(){let t=this.engine;t.setInputHandler(new It(t)),t.gameView.renderMap(t.map),t.gameView.renderStats(t.player.stats),t.gameView.renderMessages(t.messageLog),document.getElementById("dialogContainer").style.display="none",document.getElementById("inventoryDialog").style.display="none"}}let qt=new Map;var Rt,zt;let Nt;qt.set("ArrowUp",[0,-1]),qt.set("ArrowDown",[0,1]),qt.set("ArrowLeft",[-1,0]),qt.set("ArrowRight",[1,0]),qt.set("Home",[-1,-1]),qt.set("End",[-1,1]),qt.set("PageUp",[1,-1]),qt.set("PageDown",[1,1]),qt.set("Numpad1",[-1,1]),qt.set("Numpad2",[0,1]),qt.set("Numpad3",[1,1]),qt.set("Numpad4",[-1,0]),qt.set("Numpad6",[1,0]),qt.set("Numpad7",[-1,-1]),qt.set("Numpad8",[0,-1]),qt.set("Numpad9",[1,-1]),function(t){t[t.Period=0]="Period",t[t.Numpad5=1]="Numpad5",t[t.Delete=2]="Delete"}(Rt||(Rt={})),function(t){t[t.Enter=0]="Enter",t[t.NumpadEnter=1]="NumpadEnter"}(zt||(zt={}));class $t{constructor(){Nt||(Nt=new b({width:60,height:36,fontFamily:"menlo",fontSize:20,forceSquareRatio:!0,fg:"antiquewhite",bg:"black"}),document.getElementById("gameMap").appendChild(Nt.getContainer()),Nt=Nt)}renderMap(t,e){document.getElementById("mapLabel").textContent=t.label;let i=function(t,e,i){let s=[];for(let i=0;i<t;i++){s[i]=[];for(let t=0;t<e;t++)s.push(null)}return i.forEach(((t,e)=>{(!s[t.x][t.y]||s[t.x][t.y].renderOrder<t.renderOrder)&&(s[t.x][t.y]=t)})),s}(t.width,t.height,t.entities);Nt.clear();for(let s=0;s<t.width;s++)for(let n=0;n<t.height;n++){let r;r=t.visible[s][n]?t.tiles[s][n].lightTile:t.explored[s][n]?t.tiles[s][n].darkTile:N;let o=r.char,a=r.fgColor,h=r.bgColor;e&&e[0]==s&&e[1]==n&&(h="yellow");let l=i[s][n];if(t.visible[s][n]&&l)o=l.char,a=l.color;else if(t.explored[s][n]){let e=t.getSiteAt(s,n);e&&(o=e.char,a=e.darkColor)}Nt.draw(s+t.xOffset,n+t.yOffset,o,a,h)}}renderMapInfo(t){let e,i,s,n=[],r=document.getElementById("mapInfo");if(r.textContent="",!t)return;for(let s of t)s instanceof xt?e=s:s instanceof St?i=s:s instanceof bt&&n.push(s);i&&(s=document.createElement("div"),s.innerHTML=`[${i.name}]`,r.appendChild(s)),e&&(s=document.createElement("div"),s.innerHTML=`${e.name}`,r.appendChild(s));let o="",a=!0;for(let t of n)a||(o+=", "),o+=`${t.name}`,a=!1;s=document.createElement("div"),s.innerHTML=o,r.appendChild(s)}renderMessages(t){let e=document.getElementById("gameMessages");e.textContent="";for(let i of t.messages.slice().reverse()){let t=document.createElement("div");i.cssClass&&t.classList.add(i.cssClass),t.appendChild(document.createTextNode(i.fullText)),e.appendChild(t)}}renderStats(t){document.getElementById("statHp").textContent=`hp: ${t.hp} / ${t.maxHp}`}}class Ot{render(t,e){let i={},s=document.getElementById("inventoryContent");if(0==t.items.size)s.innerHTML="&lt; empty &gt;";else{s.textContent="";let n="a",r=n.charCodeAt(0);for(let o of t.items){i[n]=o;let t,a=o.name;o.equippable?e&&e.isEquipped(o)?(t="(d)rop / (t)akeoff",a+=" [equipped]"):t="(d)rop / (e)quip":t=o.combinable?"(d)rop / (c)ombine with...":o.consumable?"(d)rop / (u)se":"(d)rop";let h=document.createElement("div");h.innerHTML=`<div class="inventory-row"><div class="inventory-item-letter">(${n})</div><div class="inventory-item-name">${a}</div><div class="inventory-item-command">${t}</div></div>`,s.appendChild(h),n=String.fromCharCode(r+1),r=n.charCodeAt(0)}}return i}}class Xt{constructor(){this.actors=[],this.messageLog=new At,this.scheduler=new T,this.playerActionQueue=new $,this.fov=new C(this.transparency.bind(this)),this.gameView=new $t,this.inventoryView=new Ot,console.log("Starting engine"),this.setInputHandler(new It(this)),this.setMouseHandler(),this.world=new Et(this),this.player=function(t,e){let i,s,n,r,o,a,h;switch(e){case _t.Player:i="@",s="blue",n="player",r=30,o=2,a=4,h=26;break;case _t.Orc:i="o",s="#408040",n="orc",r=10,o=0,a=3,h=0;break;case _t.Troll:i="T",s="#008000",n="troll",r=16,o=1,a=4,h=0}let l=new xt(t,n,i,s);return l.stats=new Mt(t,l,r,o,a),h&&(l.inventory=new kt(t,l,h),l.equipment=new Tt(t,l)),e===_t.Player?l.ai=new dt(t,l):l.ai=new pt(t,l),l}(this,_t.Player),this.addActor(this.player),this.world.pushMap(Y.test_map_world),this.fov.compute(this.player.x,this.player.y,8,this.setFov.bind(this)),this.gameView.renderMap(this.map),this.gameView.renderMapInfo(),this.gameView.renderStats(this.player.stats),this.messageLog.addMessage("Welcome, adventurer!"),this.gameView.renderMessages(this.messageLog)}addActor(t){this.actors.push(t),this.scheduler.add(t,!0)}processTurn(){return t=this,e=void 0,s=function*(){let t=this.scheduler.next();yield t.act(),this.map.resetVisible(),this.fov.compute(this.player.x,this.player.y,8,this.setFov.bind(this)),this.gameView.renderMap(this.map),this.gameView.renderMapInfo(),this.gameView.renderStats(this.player.stats),this.gameView.renderMessages(this.messageLog)},new((i=void 0)||(i=Promise))((function(n,r){function o(t){try{h(s.next(t))}catch(t){r(t)}}function a(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((s=s.apply(t,e||[])).next())}));var t,e,i,s}setInputHandler(t){this.currEventListener&&document.body.removeEventListener("keydown",this.currEventListener),this.currEventListener=t.eventListener,document.body.addEventListener("keydown",this.currEventListener)}setMouseHandler(){document.body.addEventListener("mousemove",this.mouseEventListener.bind(this))}mouseEventListener(t){let e=document.getElementById("gameMap").getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top,n=Math.floor(i/20)-this.map.xOffset,r=Math.floor(s/20)-this.map.yOffset;n>=0&&n<60&&r>=0&&r<36&&this.map.visible[n][r]&&this.gameView.renderMapInfo(this.map.getEntitiesAt(n,r))}transparency(t,e){return!(t<0||t>=this.map.width||e<0||e>=this.map.height)&&this.map.tiles[t][e].transparent}setFov(t,e,i,s){t<0||t>=this.map.width||e<0||e>=this.map.height||(this.map.visible[t][e]=!!s,this.map.visible[t][e]&&(this.map.explored[t][e]=!0))}}"ontouchstart"in document.documentElement?alert("This game can be played only on desktop computers"):function(){let t=window.screen.width*window.devicePixelRatio,e=window.screen.height*window.devicePixelRatio;return t<1600||e<800}()?alert("This game can be played only on resolution 1600x800 or higher"):window.setTimeout((function(){return t=this,e=void 0,s=function*(){yield function(){return F(this,void 0,void 0,(function*(){H=yield W("terrains.txt",B.TerrainDef);const t=["test_map_world.txt","test_map_milano.txt"];let e=[];for(let i of t)e.push(W(i,B.Map));return Promise.all(e)}))}();let t=new Xt;for(;;)yield t.processTurn()},new((i=void 0)||(i=Promise))((function(n,r){function o(t){try{h(s.next(t))}catch(t){r(t)}}function a(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((s=s.apply(t,e||[])).next())}));var t,e,i,s}),500)})();
//# sourceMappingURL=main.js.map